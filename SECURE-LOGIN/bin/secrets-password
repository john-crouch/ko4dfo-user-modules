#!/bin/bash
#
# secrets-password - Change secrets container password and system password
#
# This changes both the LUKS container password and system password together,
# keeping them in sync.
#

set -e

# Load station info
if [ ! -f "$HOME/.station-info" ]; then
    echo "ERROR: No station info found. Run station-setup first."
    exit 1
fi
source $HOME/.station-info

# Paths
ARCOS_DATA=/arcHIVE
SECRETS_CONTAINER=$ARCOS_DATA/QRV/$MYCALL/secrets.luks
SECRETS_MAPPER="secrets-$MYCALL"

echo "=== Change Password for $MYCALL ==="

# Check if container exists
if [ ! -f "$SECRETS_CONTAINER" ]; then
    echo "ERROR: No secrets container found at $SECRETS_CONTAINER"
    echo "Run 'secrets-setup' first to create one."
    zenity --error --text="No secrets container found.\nRun 'secrets-setup' first." 2>/dev/null
    exit 1
fi

# Get current password
CURRENT_PASSWORD=$(zenity --password \
    --title="Current Password" \
    --text="Enter your current password:" \
    2>/dev/null)

if [ -z "$CURRENT_PASSWORD" ]; then
    zenity --error --text="No password provided. Cancelled." 2>/dev/null
    exit 1
fi

# Verify current password by attempting to open (if not already open)
echo "Verifying current password..."
ALREADY_OPEN=false
if [ -b "/dev/mapper/$SECRETS_MAPPER" ]; then
    ALREADY_OPEN=true
    echo "Container already open, will verify via key slot test"
    # Test the password by trying to add/remove it (dry run approach)
    # We'll use cryptsetup's open with a test to verify
    if ! echo -n "$CURRENT_PASSWORD" | sudo cryptsetup open --test-passphrase "$SECRETS_CONTAINER" - 2>/dev/null; then
        zenity --error --text="Incorrect current password." 2>/dev/null
        unset CURRENT_PASSWORD
        exit 1
    fi
else
    # Try to open with current password
    if echo -n "$CURRENT_PASSWORD" | sudo cryptsetup open "$SECRETS_CONTAINER" "$SECRETS_MAPPER" - 2>&1; then
        echo "Password verified"
    else
        zenity --error --text="Incorrect current password." 2>/dev/null
        unset CURRENT_PASSWORD
        exit 1
    fi
fi

# Get new password
NEW_PASSWORD=$(zenity --password \
    --title="New Password" \
    --text="Enter your new password:" \
    2>/dev/null)

if [ -z "$NEW_PASSWORD" ]; then
    zenity --error --text="No new password provided. Cancelled." 2>/dev/null
    # Close if we opened it
    if [ "$ALREADY_OPEN" = "false" ]; then
        sudo cryptsetup close "$SECRETS_MAPPER" 2>/dev/null || true
    fi
    unset CURRENT_PASSWORD
    exit 1
fi

# Confirm new password
NEW_PASSWORD_CONFIRM=$(zenity --password \
    --title="Confirm New Password" \
    --text="Re-enter your new password to confirm:" \
    2>/dev/null)

if [ "$NEW_PASSWORD" != "$NEW_PASSWORD_CONFIRM" ]; then
    zenity --error --text="New passwords do not match. Cancelled." 2>/dev/null
    if [ "$ALREADY_OPEN" = "false" ]; then
        sudo cryptsetup close "$SECRETS_MAPPER" 2>/dev/null || true
    fi
    unset CURRENT_PASSWORD NEW_PASSWORD NEW_PASSWORD_CONFIRM
    exit 1
fi
unset NEW_PASSWORD_CONFIRM

# Change LUKS password
echo "Changing LUKS container password..."
if echo -e "$CURRENT_PASSWORD\n$NEW_PASSWORD" | sudo cryptsetup luksChangeKey "$SECRETS_CONTAINER" 2>&1; then
    echo "LUKS password changed successfully"
else
    echo "ERROR: Failed to change LUKS password"
    zenity --error --text="Failed to change container password." 2>/dev/null
    if [ "$ALREADY_OPEN" = "false" ]; then
        sudo cryptsetup close "$SECRETS_MAPPER" 2>/dev/null || true
    fi
    unset CURRENT_PASSWORD NEW_PASSWORD
    exit 1
fi

# Change system password
echo "Changing system password..."
if echo "user:$NEW_PASSWORD" | sudo chpasswd 2>&1; then
    echo "System password changed successfully"
else
    echo "WARNING: Failed to change system password"
    echo "LUKS password was changed but system password may be out of sync!"
    zenity --warning --text="Container password changed, but system password update failed.\nPasswords may be out of sync!" 2>/dev/null
fi

# Clear passwords
unset CURRENT_PASSWORD NEW_PASSWORD

# Close container if we opened it (user can re-open with new password)
if [ "$ALREADY_OPEN" = "false" ]; then
    sudo cryptsetup close "$SECRETS_MAPPER" 2>/dev/null || true
    echo "Container closed"
fi

echo ""
echo "=== Password Changed Successfully ==="
echo "Both your secrets container and system password have been updated."

zenity --info \
    --title="Password Changed" \
    --text="Password changed successfully!\n\nBoth your secrets container and system login now use the new password." \
    2>/dev/null
