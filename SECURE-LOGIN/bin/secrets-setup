#!/bin/bash
#
# secrets-setup - Create encrypted secrets container and set system password
#
# This creates a LUKS-encrypted container for storing secrets.
# The container password becomes your system password (they stay in sync).
#

set -e

# Load station info
if [ ! -f "$HOME/.station-info" ]; then
    echo "ERROR: No station info found. Run station-setup first."
    exit 1
fi
source $HOME/.station-info

# Paths
ARCOS_DATA=/arcHIVE
SECRETS_CONTAINER=$ARCOS_DATA/QRV/$MYCALL/secrets.luks
SECRETS_MOUNT=/mnt/secrets
SECRETS_MAPPER="secrets-$MYCALL"
CONTAINER_SIZE_MB=32  # LUKS2 header needs ~16MB, plus space for secrets

echo "=== Secrets Container Setup for $MYCALL ==="

# Check if container already exists
if [ -f "$SECRETS_CONTAINER" ]; then
    zenity --question \
        --title="Container Exists" \
        --text="A secrets container already exists at:\n$SECRETS_CONTAINER\n\nDo you want to DELETE it and create a new one?\n\nWARNING: This will destroy all stored secrets!" \
        --ok-label="Delete and Recreate" \
        --cancel-label="Cancel" \
        2>/dev/null || exit 0

    # Close if open
    if [ -b "/dev/mapper/$SECRETS_MAPPER" ]; then
        sudo umount "$SECRETS_MOUNT" 2>/dev/null || true
        sudo cryptsetup close "$SECRETS_MAPPER" 2>/dev/null || true
    fi

    rm -f "$SECRETS_CONTAINER"
    echo "Existing container removed"
fi

# Get password
PASSWORD=$(zenity --password \
    --title="Create Secrets Container" \
    --text="Enter a password for your secrets container.\n\nThis password will also become your system login password.\nChoose a strong password you can remember." \
    2>/dev/null)

if [ -z "$PASSWORD" ]; then
    zenity --error --text="No password provided. Setup cancelled." 2>/dev/null
    exit 1
fi

# Confirm password
PASSWORD_CONFIRM=$(zenity --password \
    --title="Confirm Password" \
    --text="Re-enter your password to confirm:" \
    2>/dev/null)

if [ "$PASSWORD" != "$PASSWORD_CONFIRM" ]; then
    zenity --error --text="Passwords do not match. Setup cancelled." 2>/dev/null
    unset PASSWORD PASSWORD_CONFIRM
    exit 1
fi
unset PASSWORD_CONFIRM

echo "Creating ${CONTAINER_SIZE_MB}MB container at $SECRETS_CONTAINER..."

# Create container file
dd if=/dev/zero of="$SECRETS_CONTAINER" bs=1M count=$CONTAINER_SIZE_MB status=progress 2>&1

# Format as LUKS
echo "Formatting as LUKS encrypted container..."
if echo -n "$PASSWORD" | sudo cryptsetup luksFormat \
    --type luks2 \
    --cipher aes-xts-plain64 \
    --key-size 512 \
    --hash sha256 \
    --iter-time 2000 \
    --batch-mode \
    "$SECRETS_CONTAINER" - 2>&1; then
    echo "LUKS container created"
else
    echo "ERROR: Failed to create LUKS container"
    zenity --error --text="Failed to create encrypted container." 2>/dev/null
    rm -f "$SECRETS_CONTAINER"
    unset PASSWORD
    exit 1
fi

# Open the container
echo "Opening container..."
if echo -n "$PASSWORD" | sudo cryptsetup open "$SECRETS_CONTAINER" "$SECRETS_MAPPER" - 2>&1; then
    echo "Container opened"
else
    echo "ERROR: Failed to open container"
    zenity --error --text="Failed to open container after creation." 2>/dev/null
    rm -f "$SECRETS_CONTAINER"
    unset PASSWORD
    exit 1
fi

# Create filesystem
echo "Creating ext4 filesystem..."
sudo mkfs.ext4 -L "secrets-$MYCALL" "/dev/mapper/$SECRETS_MAPPER" 2>&1

# Mount and set permissions
sudo mkdir -p "$SECRETS_MOUNT"
sudo mount "/dev/mapper/$SECRETS_MAPPER" "$SECRETS_MOUNT"
sudo chown user:user "$SECRETS_MOUNT"

# Create a README inside
cat > "$SECRETS_MOUNT/README" << 'EOF'
SECRETS CONTAINER
=================
This encrypted container stores sensitive data.
The password used to unlock this container is also your system password.

You can store files here such as:
- API keys
- Signal LUKS keyfile (for auto-unlock)
- Other sensitive configuration

To change your password, use: secrets-password
EOF

echo "Container mounted at $SECRETS_MOUNT"

# Set system password
echo "Setting system password..."
if echo "user:$PASSWORD" | sudo chpasswd 2>&1; then
    echo "System password set successfully"
else
    echo "WARNING: Failed to set system password"
fi

# Check if old .passwd file exists and offer to remove it
OLD_PASSWD="$ARCOS_DATA/QRV/$MYCALL/.passwd"
if [ -f "$OLD_PASSWD" ]; then
    echo "Found old password hash file at $OLD_PASSWD"
    if zenity --question \
        --title="Remove Old Password File" \
        --text="Found old plaintext password hash at:\n$OLD_PASSWD\n\nThis is no longer needed with secure secrets storage.\nWould you like to remove it?" \
        --ok-label="Remove" \
        --cancel-label="Keep" \
        2>/dev/null; then
        rm -f "$OLD_PASSWD"
        echo "Old password hash removed"
    fi
fi

# Clear password
unset PASSWORD

# Summary
echo ""
echo "=== Setup Complete ==="
echo "Container: $SECRETS_CONTAINER"
echo "Mounted at: $SECRETS_MOUNT"
echo ""
echo "Your system password is now synced with your secrets container."
echo "To change your password later, use: secrets-password"

zenity --info \
    --title="Setup Complete" \
    --text="Secrets container created successfully!\n\nYour system password is now set.\nThe container is mounted at $SECRETS_MOUNT\n\nTo change your password: secrets-password" \
    2>/dev/null

# Leave mounted for this session
echo "Container will remain mounted for this session."
